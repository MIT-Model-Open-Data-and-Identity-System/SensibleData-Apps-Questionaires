{% extends "base.html" %}

{% block content %}
	<script>
		var actor;
		
		function isNumber(n) {
  			return !isNaN(parseFloat(n)) && isFinite(n);
		}
		
		function isValidInputForNumberField(field) {
			if (field.value.length > 0) {
				if (isNumber(field.value)) {
					var n = parseFloat(field.value);
					if ((n >= field.min) && (n <= field.max)) {
						return true;
					} else {
						return false;
					}
				} else {
					return false;
				}
			} else {
				return false;
			}	
		}
		
		function markRowSuccess(event) {
			row = document.getElementById(event.name);
			row.className = 'success';
		}
		
		function validateForm()
		{
			if (actor == 'prev') {
				return true;
			}
			var required_vars = document.forms["myform"]["__required_vars"].value;
			required_vars = required_vars.split(',');
			for (var idx=0; idx<required_vars.length; idx++) {
				// check if radio group:
				if ((document.forms["myform"][required_vars[idx]] instanceof NodeList) || (document.forms["myform"][required_vars[idx]] instanceof HTMLCollection)){
					var answered = false;
					for (var inner_idx=0; inner_idx < document.forms["myform"][required_vars[idx]].length; inner_idx++) {
						var counter = 0;
						if (document.forms["myform"][required_vars[idx]][inner_idx].type == "radio") {
							if (document.forms["myform"][required_vars[idx]][inner_idx].checked) {
								answered = true;
								break;
							} 
						}
						else if (document.forms["myform"][required_vars[idx]][inner_idx].type == "checkbox") {
							if (document.forms["myform"][required_vars[idx]][inner_idx].checked) {
								if (document.forms["myform"]["__required_answer_count"] > -1) {
									counter +=1;
									if (counter >= document.forms["myform"]["__required_answer_count"]) {
										answered = true;
									}
								} else {
									answered = true;
									break;
								}
							}
							
						}
						else if (document.forms["myform"][required_vars[idx]][inner_idx].max !== undefined) {
							if (isValidInputForNumberField(document.forms["myform"][required_vars[idx]][inner_idx])) {
								answered = true;
							}
						}
					}
				}
				else if (document.forms["myform"][required_vars[idx]].max !== undefined) {
							if (isValidInputForNumberField(document.forms["myform"][required_vars[idx]])) {
								answered = true;
							} else {
								answered = false;
								document.forms["myform"][required_vars[idx]].value = "";
							}
						}
				else if (document.forms["myform"][required_vars[idx]].value == null || document.forms["myform"][required_vars[idx]].value == "") {
					//document.forms["myform"][required_vars[idx]].className = 'control-group error';
					answered = false;
					break;
				} else {
					answered = true;
				}
			}
			if (!answered) {
				document.getElementById("answer_alert").style.display = "block";
 				return false;
			}
		
		}
	</script>
		<!-- progress bar goes here -->
		<div class="progress">
  			<div class="bar" style="width: {{ progress }}%;"></div>
		</div>        
		<!-- deciding on the heading -->
		{% if last_page %}
			<h1>The end</h1>
			<p>Thank you for finishing the survey, you can now close this browser tab. </p>
		{% endif %}
		
		<!-- display the error message -->
		{% if unanswered %}
			<div class="alert alert-error" id="answer_alert">
		{% else %}
			<div class="alert alert-error" id="answer_alert" style="display:none">
		{% endif %}
				Please answer the question before continuing.
			</div>
    	<form action="form" method="post" name="myform" onsubmit="return validateForm()" autofocus="autofocus">
			<fieldset>
				{% csrf_token %}
				
				<!-- display the question? -->
				{% if last_page %}
					<input type="hidden" name="__question_name" value="__goodbye" />
				{% else %}
					{{ question|safe }} 
				{% endif %}

				<div class="form-actions">
				
					<!-- Which buttons to display? -->
					{% if last_page %}
						<button type="submit" onclick="actor='prev'" name="_prev" class="btn"><i class="icon-chevron-left"></i> Previous</button>
						<button type="submit" name="_from_top" class="btn btn-primary"><i class="icon-refresh icon-white"></i> Start from the beginning</button>
					{% else %}
						<button type="submit" onclick="actor='next_new'" name="_next_new" class="btn btn-primary">Next unanswered question <i class="icon-chevron-right"></i><i class="icon-chevron-right"></i></button> 	
						<button type="submit" onclick="actor='prev'" name="_prev" class="btn"><i class="icon-chevron-left"></i> Previous</button>
						<button type="submit" onclick="actor='next'" name="_next" class="btn" id="next_button">Next <i class="icon-chevron-right"></i> </button>
					{% endif %}
			</fieldset>
		</form>


{% endblock %}
